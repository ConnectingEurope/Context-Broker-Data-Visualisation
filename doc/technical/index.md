# Technical documentation

This part of the documentation pretends to focus in the technical part of the Context Broker Data Visualization enabler, as well as explain how to develop new features or how certain parts of the enabler work.

## Content

- [Architecture](#architecture)
  - [Context Broker](#context-broker)
  - [Cygnus](#cygnus)
  - [STH-Comet](#sth-comet)
  - [MongoDB](#mongodb)
  - [Enabler Back-end](#enabler-back-end)
  - [Enabler Front-end](#enabler-front-end)
- [Used technologies](#used-technologies)
- [Understanding the code](#understanding-the-code)
  - [How to generate new graphs](#how-to-generate-new-graphs)
  - [How to change the refresh time of the information](#how-to-change-the-refresh-time-of-the-information)
  - [Supported types of subscriptions](#supported-types-of-subscriptions)
    - [Subscriptions for a specific ID with multiple attributes](#subscriptions-for-a-specific-id-with-multiple-attributes)
    - [Subscriptions for a group of entities of the same type with multiple attributes](#subscriptions-for-a-group-of-entities-of-the-same-type-with-multiple-attributes)
    - [Subscriptions for a group of entities with an idPattern with multiple attributes](#subscriptions-for-a-group-of-entities-with-an-idpattern-with-multiple-attributes)
  - [How the historical data page gets the subscribed attributes](#how-the-historical-data-page-gets-the-subscribed-attributes)

### Architecture

The following picture represents the architecture of the Context Broker Data Visualization enabler and its integration with the rest of the tools:

![Architecture](../img/Architecture.png)

It is recommended to read the links of the [Reference documentation](../../README.md#reference-documentation) section before continue reading the rest of the content.

Hereunder, the set of tools of the architecture are going to be detailed:

#### Context Broker

The Context Broker is in charge of providing real-time data to the Back-end of the enabler. The most recent information is stored in the MongoDB.

It is also integrated with Cygnus and, optionally, it notifies the changes of the data to Cygnus, by the subscriptions.

By default, it serves on the port 1026.

#### Cygnus

Through its integration with the Context Broker, Cygnus is subscribed to the changes of the real-time data information.

Because of that, Cygnus generates historical data, storing all the data that is received in the MongoDB.

By default, it serves on the port 5050.

#### STH-Comet

Once the MongoDB contains historical data (generated by the integration of the Context Broker and Cygnus), STH-Comet is in charge of read the historical data information, and also to generate aggregated data (averages, etc.).

It provides the historical data information to the Enabler Back-end.

By default, it serves on the port 8666.

#### MongoDB

The database which stores both real-time data (from the Context Broker) and historical data (from Cygnus).

It also provides the information to the rest of the tools, when they need to read the data.

By default, it serves on the port 27017.

#### Enabler Back-end

The Back-end of the enabler is a NodeJS module and acts as the server of the Front-end of the enabler.

It is in charge of send all the requests to the Context Broker and STH-Comet, managing all the data of the enabler.

It also stores the configuration of the Configuration page in an internal JSON file called configuration.

By default, it serves on the port 3000.

#### Enabler Front-end

The Front-end of the enabler consists on the visualization layer. It contains all the views of the enabler (map, configuration, historical data, etc.) and requests all the information to be displayed directly to the Back-end.

By default, it serves on the port 4200.

### Used technologies

The following technologies has been used for the development and the deployment of the Context Broker Data Visualization enabler:

- [Angular](https://angular.io/)
- [OpenStreetMap](https://www.openstreetmap.org/)
- [Leaflet](https://leafletjs.com/)
- [NodeJS](https://nodejs.org/)
- [ChartJS](https://www.chartjs.org/)
- [MongoDB](https://www.mongodb.com/)
- [Docker](https://www.docker.com/)
- [GitHub](https://github.com/)
- [DockerHub](https://hub.docker.com/)
- [Orion Context Broker](https://github.com/telefonicaid/fiware-orion)
- [Cygnus](https://github.com/telefonicaid/fiware-cygnus)
- [STH-Comet](https://github.com/telefonicaid/fiware-sth-comet)
- [FIWARE lab](https://www.fiware.org/developers/fiware-lab/)
- [Markdown](https://www.markdownguide.org/)

### Understanding the code

The objective of this section is to explain different technical points of the enabler, including new developments, modify parts of the enabler, etc.

#### How to generate new graphs

The graphs of the enabler are generated using [ChartJS](https://www.chartjs.org/). There are available different [types of graphs](https://www.chartjs.org/docs/latest/charts/).

Currentle, the enabler uses the [line graph](https://www.chartjs.org/docs/latest/charts/line.html) for numerical attributes and the [bar graph](https://www.chartjs.org/docs/latest/charts/bar.html) for text (String) attributes.

**TO DO: COMPLETE THE SECTION**

#### How to change the refresh time of the information

By default, the refresh time of the real-time data in the map is 1 minute. In milliseconds, it is 60000.

This refresh time can be changed, modifying a value in the map-dashboard.component.ts. It is located inside the visualizeEntities function:

```typescript
private visualizeEntities(): void {
        this.loadEntities();
        this.interval = setInterval(() => {
            this.loadedIdsCopy = JSON.parse(JSON.stringify(this.loadedIds));
            this.loadEntities();
        }, 60000);
    }
```

In this case, the last value of the function (60000) can be replaced by the desired refresh time (in milliseconds).

#### Supported types of subscriptions

With the objective of generate historical data, Cygnus is subscribed to the Context Broker. Then, when the Context Broker receives new data and, if this data matches with the configuration of the subscription, it is sent to Cygnus (and stored in MongoDB).

There are some examples for subscriptions in this [link](https://documenter.getpostman.com/view/513743/RWEgqe8Q?version=latest#5ae8856f-954c-4e6b-a577-e03644bebb70).

In relation with the subscriptions, there are lots of possibilities to configure them. Depending on the IDs of the entities, their attributes, the conditions for the notification, etc.

For the Context Broker Data Visualization enabler, the **supported subscriptions** between Cygnus and the Context Broker are:

##### Subscriptions for a specific ID with multiple attributes

This type of subscription is focused to the entity which ID is the same than the one indicated in the request. Concretely, in the **id** key.

All the desired attributes to be subscribed for the specific entity, need to be included in the **notification -> attrs list**.

This is the structure of the request for this kind of subscription:

**URL:** http://localhost:1026/v2/subscriptions/

```json
{
  "description": "Notify Cygnus the changes of the attributes for the entity ENTITY_ID_1",
  "subject": {
    "entities": [
      {
        "id": "ENTITY_ID_1",
        "type": "TYPE_OF_THE_ENTITY"
      }
    ],
    "condition": {
      "attrs": []
    }
  },
  "notification": {
    "http": {
      "url": "http://cygnus:5051/notify"
    },
    "attrs": [
      "ATTRIBUTE_1",
      "ATTRIBUTE_2",
      "ATTRIBUTE_N"
    ]
  }
}
```

##### Subscriptions for a group of entities of the same type with multiple attributes

This type of subscription is focused to a **group of entities of the same type**.

All the desired attributes to be subscribed for the specific entity, need to be included in the **notification -> attrs list**.

This is the structure of the request for this kind of subscription:

**URL:** http://localhost:1026/v2/subscriptions/

```json
{
  "description": "Notify Cygnus the changes of the attributes for the entities of type TYPE_OF_THE_ENTITIES",
  "subject": {
    "entities": [
      {
        "idPattern": ".*",
        "type": "TYPE_OF_THE_ENTITIES"
      }
    ],
    "condition": {
      "attrs": []
    }
  },
  "notification": {
    "http": {
      "url": "http://cygnus:5051/notify"
    },
    "attrs": [
      "ATTRIBUTE_1",
      "ATTRIBUTE_2",
      "ATTRIBUTE_N"
    ]
  }
}
```

##### Subscriptions for a group of entities with an idPattern with multiple attributes

This type of subscription is focused to a **group of entities of the same type**, whose **id** matches the regex of the **idPattern** key.

All the desired attributes to be subscribed for the specific entity, need to be included in the **notification -> attrs list**.

This is the structure of the request for this kind of subscription:

**URL:** http://localhost:1026/v2/subscriptions/

```json
{
  "description": "Notify Cygnus the changes of the attributes for the entities of type TYPE_OF_THE_ENTITIES which IDs start by PARKING",
  "subject": {
    "entities": [
      {
        "idPattern": "PARKING.*",
        "type": "TYPE_OF_THE_ENTITIES"
      }
    ],
    "condition": {
      "attrs": []
    }
  },
  "notification": {
    "http": {
      "url": "http://cygnus:5051/notify"
    },
    "attrs": [
      "ATTRIBUTE_1",
      "ATTRIBUTE_2",
      "ATTRIBUTE_N"
    ]
  }
}
```

#### How the historical data page gets the subscribed attributes

First of all and **before loading** the historical data page, a **calculation** is made in order to collect the attributes which have subscriptions for changes.

For that, the Enabler gets the **subscribed attributes from the subscription list of the Context Broker** (it is external to the enabler, configuration of the Context Broker) and **compares** it with the **configured attributes on the Configuration page** for the type of the selected sensor (which are the ones displayed in the pop-up).

Then, using that information, the enabler **connects with STH-Comet** in order to receive the information of the page.

As a resume, **the information is previously collected, combined and structured** before been displayed in the historical data page of the enabler.

This is an example of a calculation:

- List of attributes of the subscription list of the Context Broker: [ATTR1, ATTR2, ATTR3, ATTR4, ATTR5]
- List of attributes for the type of the sensor in the Configuration page: [ATTR2, ATTR4, ATTR5, ATTR6]
- Attributes to be displayed in the historical data page: [ATTR2, ATTR4, ATTR5]
